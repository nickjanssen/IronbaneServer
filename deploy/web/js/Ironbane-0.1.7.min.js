/*! Ironbane 2013-05-23 */
angular.module("IronbaneApp",[]).constant("DEFAULT_AVATAR","/images/noavatar.png").run(["User","$rootScope",function(e,r){r.currentUser={},e.getCurrentUser().then(function(e){angular.copy(e,r.currentUser)})}]).config(["$routeProvider","$locationProvider",function(e,r){r.html5Mode(!0),e.when("/",{templateUrl:"/views/home",controller:"HomeCtrl"}).when("/register",{templateUrl:"/views/register",controller:"RegisterCtrl"}).when("/login",{templateUrl:"/views/login",controller:"LoginCtrl"}).when("/article/:articleId",{templateUrl:"/views/article",controller:"ArticleCtrl",resolve:{ArticleData:["Article","$q","$log","$route",function(e,r,t,o){var n=r.defer();return e.get(o.current.params.articleId).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}]}}).when("/forum",{templateUrl:"/views/forum",controller:"ForumCtrl"}).when("/forum/:boardId",{templateUrl:"/views/board",controller:"BoardCtrl",resolve:{ResolveData:["Board","Post","$q","$route",function(e,r,t,o){var n=t.defer(),a=o.current.params.boardId;return t.all([e.get(a),r.getTopics(a)]).then(function(e){n.resolve({board:e[0],posts:e[1]})},function(e){n.reject(e)}),n.promise}]}}).when("/forum/:boardId/post",{templateUrl:"/views/postEdit",controller:"PostEditCtrl",resolve:{BoardData:["Board","$route",function(e,r){return e.get(r.current.params.boardId)}]}}).otherwise({redirectTo:"/"})}]),angular.module("IronbaneApp").controller("ArticleCtrl",["$scope","ArticleData","$log","$rootScope",function(e,r,t,o){e.article=r,o.subTitle=e.article.title,e.$on("destroy",function(){o.subTitle=null})}]),angular.module("IronbaneApp").controller("BoardCtrl",["$scope","ResolveData","$location",function(e,r,t){e.board=r.board,e.posts=r.posts,e.newTopic=function(){t.path("/forum/"+e.board.id+"/post")}}]),angular.module("IronbaneApp").controller("ForumCtrl",["$scope","ForumCategory",function(e,r){e.cats=r.getAllWithBoards()}]),angular.module("IronbaneApp").controller("HomeCtrl",["$scope",function(e){e.foo="bar!"}]),angular.module("IronbaneApp").controller("LoginCtrl",["$scope","User","$log","$location",function(e,r,t,o){e.loginError=!1,e.login=function(){e.loginError=!1,r.login(e.username,e.password).then(function(){t.log("login success?"),o.path("/")},function(r){t.warn("login error!",r),e.loginError=!0})}}]),angular.module("IronbaneApp").controller("PostEditCtrl",["$scope","Post","BoardData","$log",function(e,r,t,o){e.board=t,e.save=function(){var t=new r({title:e.title,time:(new Date).valueOf()/1e3,bbcontent:e.content,user:1});o.log("about to save post",t),t.$save(e.board.id)}}]),angular.module("IronbaneApp").controller("RegisterCtrl",["$scope","$http","$log",function(e,r,t){e.register=function(){e.registerForm.$valid?r.post("/api/user",e.user).success(function(e){t.log("registration success",e)}).error(function(e){t.warn("registration error",e)}):t.warn("form's not valid buddy...")}}]),angular.module("IronbaneApp").directive("markItUp",[function(){var e={previewParserPath:"",markupSet:[{name:"Bold",key:"B",openWith:"[b]",closeWith:"[/b]"},{name:"Italic",key:"I",openWith:"[i]",closeWith:"[/i]"},{name:"Underline",key:"U",openWith:"[u]",closeWith:"[/u]"},{separator:"---------------"},{name:"Picture",key:"P",replaceWith:"[img][![Url]!][/img]"},{name:"Link",key:"L",openWith:"[url=[![Url]!]]",closeWith:"[/url]",placeHolder:"Your text to link here..."},{separator:"---------------"},{name:"Size",key:"S",openWith:"[size=[![Text size]!]]",closeWith:"[/size]",dropMenu:[{name:"Big",openWith:"[size=200]",closeWith:"[/size]"},{name:"Normal",openWith:"[size=100]",closeWith:"[/size]"},{name:"Small",openWith:"[size=50]",closeWith:"[/size]"}]},{separator:"---------------"},{name:"Bulleted list",openWith:"[list]\n",closeWith:"\n[/list]"},{name:"Numeric list",openWith:"[list=[![Starting number]!]]\n",closeWith:"\n[/list]"},{name:"List item",openWith:"[*] "},{separator:"---------------"},{name:"Quotes",openWith:"[quote]",closeWith:"[/quote]"},{name:"Code",openWith:"[code]",closeWith:"[/code]"},{separator:"---------------"},{name:"Clean",className:"clean",replaceWith:function(e){return e.selection.replace(/\[(.*?)\]/g,"")}},{name:"Preview",className:"preview",call:"preview"}]};return{restrict:"AE",replace:!0,template:"<textarea></textarea>",link:function(r,t){t.markItUp(e)}}}]),angular.module("IronbaneApp").factory("Article",["$http","$log","$templateCache",function(e,r,t){var o=function(e){angular.copy(e||{},this)};return o.get=function(n){return e.get("/api/article/"+n).then(function(e){var r=new o(e.data);return r.cacheUrl="__articleCache/"+n,t.put(r.cacheUrl,r.body),r},function(e){r.error("error retreiving article",e)})},o}]),angular.module("IronbaneApp").factory("ForumCategory",["$http","Board","$log",function(e,r,t){var o=function(e){angular.copy(e||{},this)};return o.getAll=function(){var r=e.get("/api/forum/cats").then(function(e){var r=e.data;return r.forEach(function(e,t){r[t]=new o(r[t])}),r},function(e){t.error("Error retreiving categories from server.",e)});return r},o.getAllWithBoards=function(){var e=[];return r.getAll().then(function(r){var t=null;return r.forEach(function(r){(null===t||t.name!==r.category)&&(t&&e.push(t),t=new o({name:r.category,id:r.forumcat,boards:[]})),t.boards.push(r)}),e.push(t),e})},o}]).factory("Board",["$log","$http",function(e,r){var t=function(e){angular.copy(e||{},this),this.url="/forum/"+this.id,this.postCount=0,this.topicCount=0};return t.get=function(o){var n=r.get("/api/forum/"+o,{cache:!0}).then(function(e){var r=new t(e.data);return r},function(r){e.error("Error getting board from server",r)});return n},t.getAll=function(){var o=r.get("/api/forum").then(function(e){var r=e.data;return r.forEach(function(e,o){r[o]=new t(e)}),r},function(r){e.error("Error getting boards from server",r)});return o},t.getAllByCategory=function(){},t}]).factory("Post",["$log","$http","User",function(e,r,t){var o=function(e){angular.copy(e||{},this)};return o.prototype.$save=function(t){var o="/api/forum/"+t+"/topics",n=r.post(o,this).then(function(r){e.log("success saving post!",r.data)},function(r){e.error("error saving post",r)});return n},o.getTopics=function(e){var n=r.get("/api/forum/"+e+"/topics").then(function(e){var r=e.data;return r.forEach(function(e,n){e.author=new t(e.author),r[n]=new o(e)}),r});return n},o}]),angular.module("IronbaneApp").factory("User",["DEFAULT_AVATAR","$http","$log","$q","$rootScope",function(e,r,t,o,n){var a=function(e){angular.copy(e||{},this)};return a.prototype.roles=[],a.prototype.$avatar=function(){return this.forum_avatar||e},a.prototype.$hasRole=function(e){return this.roles.indexOf(e)>=0},a.login=function(e,t){return r.post("/login",{username:e,password:t}).then(function(e){return n.currentUser=new a(e.data),!0},function(e){return o.reject(e)})},a.getCurrentUser=function(){var e=o.defer();return r.get("/api/session/user").then(function(r){t.log("get user success",r);var o=new a(r.data);o.authenticated=!0,e.resolve(o)},function(r){if(404===r.status){var t=new a({id:0,username:"guest",authenticated:!1});e.resolve(t)}else e.reject(r)}),e.promise},a}]);